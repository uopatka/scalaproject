@(entries: List[models.Entry],
sortedBooks: List[models.Book],
selectedBook: Option[(models.Entry, models.Book)] = None,
notes: Seq[models.Note] = Seq.empty,
username: Option[String] = None,
filters: Map[String, String] = Map.empty)(implicit request: play.api.mvc.RequestHeader)

@import viewmodels.CoverResolver
@import java.time.format.DateTimeFormatter

@defining(DateTimeFormatter.ofPattern("dd-MM-yyyy")){ dateFormatter =>

@main("Strona główna") {
<style>
    .green-background-panel {
        background-color: #4A9782;
        padding: 20px;
        border-radius: 4px;
        min-height: 450px;
        color: white;
    }

    .book-button {
        display: block;
        width: 100%;
        padding: 14px 16px;
        border-radius: 6px;
        color: white;
        text-decoration: none;
        transition: background-color 0.2s ease;
        margin: 10px auto;
    }

    .book-button:hover {
        background-color: rgba(255, 255, 255, 0.15);
        color: white;
    }

    .book-button.active {
        background-color: rgba(255, 255, 255, 0.25);
    }

    .book-author {
        font-size: 0.85rem;
        opacity: 0.85;
    }
</style>

<div class="container mt-4">
    @* Sekcja użytkownika *@
    <div class="d-flex justify-content-end mb-3">
        @username.map { name =>
        <div class="user-info d-flex flex-column align-items-end">
            <div>
            Witaj, <strong>@name</strong>!
            <a href="@routes.AuthController.logout()" class="btn btn-outline-danger btn-sm ms-2">Wyloguj się</a>
            </div>

            <div class="mt-1">
                <a href ="@routes.NoteController.showNotes"
                   class = "btn btn-link btn-sm p-0">
                    Moje notatki
                </a>
            </div>
        </div>
        }.getOrElse {
        <a href="@routes.AuthController.loginPage()" class="btn btn-outline-primary btn-sm">Zaloguj się</a>
        }
    </div>

    @* Nagłówek strony *@
    <div class="text-center mb-5">
        <h1 class="display-3 d-flex align-items-center justify-content-center">
            <img src="@routes.Assets.versioned("images/bookworm.png")"
            alt="Bugshelv Icon"
            style="height: 1em; width: auto;"
            class="me-3">
            Bugshelv
        </h1>
        <div class="mt-3">
            <a href="@routes.HomeController.addBook()" class="btn btn-light btn-lg shadow-sm">
                <i class="bi bi-plus-lg"></i> Dodaj książkę
            </a>
        </div>
    </div>

    @* Główna zawartość *@
    <div class="row align-items-stretch">
        @* LEWA KOLUMNA *@
        <div class="col-md-7 d-flex flex-column">
            <div class="green-background-panel h-100">
            @* Filtry POWYŻEJ kontenera *@
            @if(entries.nonEmpty || filters.nonEmpty) {
            <div class="d-flex align-items-center gap-2 mb-4">
                <div class="search-bar">
                    <form method="GET"
                          action="@routes.HomeController.index()"
                          class="d-flex align-items-center gap-2">

                        <input
                                type="search"
                                name="search"
                                class="form-control form-control-sm"
                                placeholder="Szukaj…"
                                value="@filters.getOrElse("search", "")"
                                style="width: 300px"
                        />

                        @for((key, value) <- filters if key != "search") {
                        <input type="hidden" name="@key" value="@value" />
                        }
                        <!-- <button class="btn btn-outline-secondary btn-sm" type="submit">
                            ⌕
                        </button> -->
                    </form>
                </div>
                <div class="dropdown ms-auto">
                    <button class="btn btn-light btn-sm dropdown-toggle shadow-sm" type="button" data-bs-toggle="dropdown">
                        Filtruj według statusu
                    </button>
                    <ul class="dropdown-menu">
                        @defining(List(
                        ("all", "Wszystkie"),
                        ("to_read", "Planowane"),
                        ("reading", "Czytane"),
                        ("finished", "Przeczytane"),
                        ("dropped", "Porzucone")
                        )) { statuses =>
                        @for((statusParam, label) <- statuses) {
                        @defining(if (statusParam == "all") filters - "status" else filters + ("status" -> statusParam)) { queryMap =>
                        <li>
                            <a class="dropdown-item @if(filters.get("status").contains(statusParam)) { active }"
                            href="@(routes.HomeController.index().url + (if (queryMap.nonEmpty) "?" + queryMap.map { case (k,v) => k + "=" + v }.mkString("&") else ""))">
                            @label
                            </a>
                        </li>
                        }
                        }
                        }
                    </ul>
                </div>

                <div class="dropdown">
                    <button class="btn btn-light btn-sm dropdown-toggle shadow-sm" type="button" data-bs-toggle="dropdown">
                        Sortuj
                    </button>
                    <ul class="dropdown-menu">
                        @defining(List(
                        ("title_asc", "Tytuł ↑"), ("title_desc", "Tytuł ↓"),
                        ("author_asc", "Autor ↑"), ("author_desc", "Autor ↓"),
                        ("year_asc", "Rok ↑"), ("year_desc", "Rok ↓")
                        )) { sortOptions =>
                        @for((sortParam, label) <- sortOptions) {
                        @defining(filters + ("sort" -> sortParam)) { queryMap =>
                        <li>
                            <a class="dropdown-item @if(filters.get("sort").contains(sortParam)) { active }"
                            href="@(routes.HomeController.index().url + "?" + queryMap.map { case (k,v) => k + "=" + v }.mkString("&"))">
                            @label
                            </a>
                        </li>
                        }
                        }
                        }
                    </ul>
                </div>
            </div>

            }

            @* Zielony kontener z książkami *@
            <div class="d-flex flex-column align-items-center">
                @if(entries.isEmpty) {
                <p>Brak książek.</p>
                } else {
                @for(entry <- entries) {
                @defining(sortedBooks.find(_.isbn == entry.refId)) { bookOpt =>
                @defining(
                routes.HomeController.showBook(entry.refId).url +
                (if (filters.nonEmpty) "?" + filters.map { case (k,v) => k + "=" + v }.mkString("&") else "")
                ) { bookUrl =>
                <a href="@bookUrl" class="book-button @if(selectedBook.exists(_._1.refId == entry.refId)) { active }">
                    @bookOpt.map { book =>
                    <strong>@book.title</strong><br>
                    <span class="book-author">@book.author</span>
                    }.getOrElse {
                    <em>Nieznana książka (ISBN: @entry.refId)</em>
                    }
                </a>
                }
                }
                }
                }
            </div>
        </div>
            </div>

        @* prawa kolumna *@
        <div class="col-md-5 d-flex flex-column">
            <div class="green-background-panel h-100 ">
                @selectedBook.map { case (entry, book) =>
                <div class="mb-3">
                    <a href="@routes.HomeController.deleteBook(entry.id)" class="btn btn-light btn-sm shadow-sm">Usuń</a>
                    <a href="@routes.HomeController.editBookEntry(entry.id)" class="btn btn-light btn-sm shadow-sm">Edytuj</a>
                </div>

                <div class="text-center mb-3">
                    <img src="@CoverResolver.resolve(entry, book)" class="img-fluid rounded shadow" style="max-height: 300px;">
                </div>

                <h3>@book.title</h3>
                <p><strong>Autor:</strong> @book.author</p>
                <p><strong>Status:</strong> @entry.status</p>
                <p><strong>Strony:</strong> @entry.pagesRead / @if(book.pages == 0) {?} else {@book.pages}</p>

                <hr>
                <h4>Notatki</h4>
                @if(notes.isEmpty) {
                <p>Brak notatek.</p>
                } else {
                @for(note <- notes) {
                <div class="note-card mb-2 p-2 border rounded text-dark bg-light">
                    <strong>@note.title</strong>
                    <p class="mb-1">@note.content</p>
                    <div class="mt-1">
                        <a href="@routes.NoteController.edit(note.id)" class="btn btn-sm btn-link p-0">Edytuj</a>
                        <form action="@routes.NoteController.delete(note.id)" method="POST" style="display:inline;">
                            @helper.CSRF.formField
                            <button type="submit" class="btn btn-sm btn-link text-danger p-0 ms-2">Usuń</button>
                        </form>
                    </div>
                </div>
                }
                }
                <a href="@routes.NoteController.add(entry.id)" class="btn btn-success btn-sm mt-2">Dodaj notatkę</a>

                }.getOrElse {
                <p>Wybierz książkę z listy, aby zobaczyć szczegóły.</p>
                }
            </div>
        </div>
    </div>
</div>
}
}
<br>
<br>